<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" href="./style/ve-table.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <style>
      .ve-table-container {
        overflow-y: scroll;
        position: relative;
      }

      .virtual-view-phantom {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        z-index: -1;
      }

      .ve-table-content {
        left: 0;
        right: 0;
        top: 0;
        position: absolute;
      }

      .table-shadow {
        left: 0;
        right: 0;
        top: 0;
        position: absolute;
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <button @click="changeTotalCount(500)">500 条</button>
      <button @click="changeTotalCount(1000)">1000 条</button>
      <button @click="changeTotalCount(10000)">1万 条</button>
      <button @click="changeTotalCount(100000)">10万 条</button>
      <div class="ve-table" style="margin-top:20px;">
        <div
          class="ve-table-container ve-table-border-around"
          :style="{'height':height+'px'}"
          @scroll="scrollHandler"
          ref="container"
        >
          <div
            class="virtual-view-phantom"
            :style="{'height':contentHeight}"
          ></div>
          <div class="table-shadow" ref="table-shadow"></div>
          <table ref="content" class="ve-table-content ve-table-border-x">
            <colgroup>
              <col style="width: 15%;" />
              <col style="width: 15%;" />
              <col style="width: 15%;" />
              <col />
            </colgroup>
            <thead class="ve-table-fixed-header ve-table-header">
              <tr class="ve-table-header-tr">
                <th
                  class="ve-table-header-th"
                  style="text-align: center; top: 0px;"
                >
                  Name
                </th>
                <th
                  class="ve-table-header-th"
                  style="text-align: left; top: 0px;"
                >
                  Tel
                </th>
                <th
                  class="ve-table-header-th"
                  style="text-align: right; top: 0px;"
                >
                  Hobby
                </th>
                <th
                  class="ve-table-header-th"
                  style="text-align: center; top: 0px;"
                >
                  Address
                </th>
              </tr>
            </thead>
            <tbody class="ve-table-body">
              <tr
                class="ve-table-body-tr"
                :key="index"
                v-for="(item,index) in visibleData"
              >
                <td class="ve-table-body-td" v-html="item.name"></td>
                <td class="ve-table-body-td" v-html="item.tel"></td>
                <td class="ve-table-body-td">{{item.hobby}}</td>
                <td class="ve-table-body-td">{{item.address}}</td>
              </tr>
            </tbody>
            <tfoot class="ve-table-footer"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </body>
</html>
<script>
  var app = new Vue({
    el: "#app",
    data() {
      return {
        tableData: [],
        visibleData: [],
        height: 420,
        itemHeight: 42,
        totalCount: 500,
        scrollTop: 0,
        extraCount: 50,
      };
    },
    computed: {
      // 虚拟视图占位的总高度
      contentHeight() {
        return this.tableData.length * this.itemHeight + "px";
      },
      /* itemHeight(){
        const random = [30,20,]
      } */
    },
    watch: {
      totalCount: {
        handler: function() {
          this.initTableData();
        },
        immediate: true,
      },
      tableData: {
        handler: function(newVal, preVal) {
          this.$nextTick(() => {
            this.updateVisibleData();
          });
        },
        immediate: true,
      },
    },
    methods: {
      // scroll handler
      scrollHandler() {
        this.scrollTop = this.$refs["container"].scrollTop;
        this.updateVisibleData();
      },

      // update visible data
      updateVisibleData() {
        const scrollTop = this.scrollTop || 0;
        /* const visibleCount = Math.ceil(
          this.$refs["container"].clientHeight / this.itemHeight
        ); */
        const visibleCount = Math.ceil(this.height / this.itemHeight);
        const start = Math.floor(scrollTop / this.itemHeight);
        const end = start + visibleCount;

        this.visibleData = this.tableData.slice(start, end);
        this.$refs["content"].style.top = scrollTop + "px";
        this.$refs["table-shadow"].style.top = scrollTop + "px";
      },

      getRandom(min, max) {
        return Math.floor(Math.random() * (max - min) + min);
      },

      initTableData() {
        let tableData = [];
        for (let i = 0; i < this.totalCount; i++) {
          let name = i;
          if (i % 2 === 0) {
            const rowCount = this.getRandom(5, 20);

            for (let i = 0; i < rowCount; i++) {
              name += `this is the long word.<br />`;
            }
          }

          tableData.push({
            name: name,
            tel: i,
            hobby: i,
            address: i,
          });
        }

        this.tableData = tableData;
      },

      // change total count
      changeTotalCount(count) {
        this.totalCount = count;
      },
    },
  });
</script>
